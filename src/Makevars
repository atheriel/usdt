PKG_CPPFLAGS = -Ivendor/libstapsdt/src -Ivendor/libusdt

all: $(SHLIB)
$(SHLIB): vendor

UNAME := $(shell uname -s)
ifeq ($(UNAME),Linux)
PKG_LIBS = -Lvendor/libstapsdt/out -lstapsdt -lelf -ldl

vendor:
	cd vendor/libstapsdt && $(MAKE) CC="$(CC)" CFLAGS="$(CFLAGS) $(CPICFLAGS)" AR="$(AR)" RANLIB="$(RANLIB)"

clean:
	cd vendor/libstapsdt && $(MAKE) clean
else
PKG_LIBS = -Lvendor/libusdt -lusdt

# Solaris workarounds.
ifeq ($(UNAME),SunOS)
# libusdt uses isainfo -k to detect the architecture on Solaris, which seems to
# be incompatible with R's Solaris environment.
ARCH := $(shell uname -p)
else
ARCH := $(shell uname -m)
endif

vendor:
	$(MAKE) -C vendor/libusdt ARCH="$(ARCH)" CC="$(CC)" CFLAGS="$(CFLAGS) $(CPICFLAGS)" AR="$(AR)" ARFLAGS="$(ARFLAGS)" RANLIB="$(RANLIB)"

clean:
	$(MAKE) -C vendor/libusdt clean
endif

.PHONY: all vendor clean
